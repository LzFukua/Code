### 离线话术
那我从数据源开始说吧,您有问题可以随时打断我,因为有一段时间没做了我不是太记得.
我们的数据主要是app端,小程序端,web端埋点获取到的用户行为数据,还有业务库里的数据,第三方数据等去获得. 

1. 在采集模块上
针对主流的数据源也就是埋点获得的数据我们是用flume采集,对于另一边业务库的数据我们采用的是DataX去导入.

2. 在采集这部分我们跟前端做了个数据总线模块,目的就是为了去观察采集时的健康状态和上面的日志条数,以及会去进行判断是否去重的功能.

3. 到了数仓分层模块,我们数仓主要分为四层
ODS层主要用来保存flume采集来的数据,我们在这一层不会做任何的处理,保留最元u你是的数据去方便以后出问题时候数据溯源.

然后我们讲ODS层的数据经过一系列的预处理,包括数据清洗,过滤,脱敏,guid生成,地理位置回补这些但不等的操作后,生成一些用户明细数据表放到DWD层. 然后一些DataX导入的业务数据也会放到这.

再到DWS层,我们在这做进行了主题的划分,主体划分为房东和用户两大群体,再去自下而上的进行划分主题,根据业务需求或者业务过程的分析视角来进行划分,也就是ADS层需要什么我就做什么.比如有流量主题,民宿订单转化漏斗主题,归因主题,用户活跃主题等等

将做好的报表放到ADS层之后我们就存在doris里,方便BI的报表展示

4. 然后在外围模块上,我们是用的dolphin进行的任务调度,用的Atlas做元数据管理,对我们的表进行备注,然后理清血缘等操作.最后他们最近为了做数据治理自己做了质量管理系统,具体我不是很了解

5. 在Olap模块上,也就是我们web页面是以doris做数据库,能快速返回结果/


### ODS有多少张表,都是什么?最大的一张表有多少数据量
我负责的用户行为域 有个十多张吧 
比如有小程序访问日志表 web端的访问日志表 app访问日志表 
然后接到dataX导入过来的有 
活动规则表 活动信息表 地域表 优惠券表 会员等级表(普通白银黄金钻石)
民宿订单表 积分表  等等 

最大的一张表是app用户行为数据表,每天的数据条数会有千万,旺季会达到亿级别


### 数仓命名 
层名-事业部-业务线-房东或者用户-主题域-自定义名字-更新周期

### 日活 月活 数据量 条数 
日活80-100万 月活300万 每天100G数据  峰值有200G



### dataX增量脚本多还是全量脚本多 
据我所知一开始的什么字典表啊地域表规则表或者是那些几乎不会更变数据的表都是用的全量
而那些会更新得比较频繁的表,比如订单表啊,会员信息表我们就会每日增量的去导入,然后做成拉链表的形式放到dwd层



### 项目建设层设计到的数据调研和探索的内容大概有什么
和业务需求人员对接,数据保留的时间,数据重要的字段,统一口径字段等等


### 维度建模流程
1. 首先是以相对应的业务过程确定事实表的类型是什么
2. 然后开始精确事实表每一个字段的业务含义是什么，选择用最细粒度的字段
3. 于是围绕这个业务过程的事件发散他的描述维度信息
4. 再到确定这个过程度量是什么
5. 有需要的话将一些维度退化到事实表中
6. 再开始确定我们的命名规范，完成设计。


### 数仓建模流程
我们是自下而上的建模流程，针对客户的需求，需要什么我们做什么
1. 首先我们会去开几个与业务部门的会议或者单独的聊天进行需求沟通，统一口径，梳理好业务逻辑，确定主题域
2. 我们拿到PRD文档后,我们就会开始画ER图去来明确业务的构造，确定相应的字段，明确原子指标，派生指标，衍生指标，建立中心事实表
3. 对指标进行扩散思维去拿到相应的维度，进行维度建模
4. 开始落地实表，注意一些命名规范
5. 最后进行数据校验的工作，等测试完成后续进行不断的优化操作。



###  数据量问题 业务特征 规模 用户规模  计算 (时长, 事件频次, 日志数据大小 ,用户数据)
木鸟 5000万用户  100-150万活跃度 
差不多10多秒产生一个数据 
一个人一次事件产生1.2kb
每个活跃用户平均产生70-80条数据 
每个人一天的事件大小85kb左右
每天200多G  
平均公司 按最大的来算就3.5M/s的数据
高峰期35M/s 
(只是暂时的 还需要更改)



### 数据服务总线   为什么开发这个服务
这个服务主要是是能给数仓提供了统计每个服务器日志的行数以及flume采集到的HDFS日志的行数,主要的功能有日志上报和日志条数查询
我们这个用到了spring boot嘛 
1. 日志的上报功能就是通过请求服务接口来传递参数,将每天的日志条数,日志类型,日期,以及服务器名等等上报到服务端,然后将数据通过Mybatis框架存储到Mysql中,且会发送邮件来提示是否已经上传成功

2. 日志的查询功能具体就是调用服务端的接口的来从Mysql中查询日志行数和HDFS的的文件行数来供后续的去重脚本使用


### 你们事实表包含哪些维度和度量 
维度：地域商圈 客群分类 房源描述 住客点评
度量  
Occ客房入住率 
ADR已售客房平均房价 
RevPAR 可供出租客房的收入 
Revenue月收入
CTP 营业利润贡献
GSS 宾客满意程度指数
MPI 市场渗透指数 

浏览量
点击量
CTR 点击量/浏览量



### UDF的使用 
我们在做地理位置回补创建字典表的时候,将经纬度退化成geohash值就用到了UDF
还有个人信息用AES加密算法加密、脱敏等也用到了
还有在做特殊指标的时候会用到



### 拉链表有什么
拉链表多说几个表 用户活跃 用户订单 用户会员等级


### 什么是拉链表
拉链表就是对我们收到这个信息的一个历史变动然后我们进行处理的形式嘛,也就是保留了历史的一些状态,还有新增的变化数据.
最新数据为开链数据，历史数据称为闭链数据。

### 拉链表的使用场景
1. 表中的部分字段会被更新
2. 需要查看某一个时间点或者时间段的历史信息(例如某个用户在某一个历史时间点的手机号码)
3. 变化比例不是很大的(例如1000万用户总共有每天发生变化的10多万左右)


### 拉链表维护计算的基本逻辑
拉链表一个时间维度中同一个用户只保存一条用户状态。拉链表通常会增加三个“开始日期starttime、结束日期endtime、状态标识mark”。我们就用当前数据通过主键与历史数据进行对比，判断当前数据与历史数据是否发生变化，如果发生变化就进行相应的开链、闭链操作。

### 你们拉链表有哪些表
订单表 用户会员等级表 用户信息表 用户ip所在地域表


### 拉链表补充

- 查询性能：随着时间的推移，拉链表会越来越大，查询性能也可能会有所下降
  保留部分历史数据，比如说一张表里存放着全量的拉链表数据，我们只对外提供一张近3个月数据的拉链表。
- 使用拉链表的时候可以不加end_date，但是加上之后，能优化很多查询；
- 可以加上当前行状态标识，能快速定位到当前状态；
- 在拉链表的设计中可以加一些内容，因为我们每天保存一个状态，如果我们在这个状态里面加一个字段，比如如当天修改次数，那么拉链表的作用就会更大。



### 缓慢变化维有几种 
1. 第一种方式是直接覆盖原值
2. 第二种方式是用代理键去区分历史数据和新增数据
3. 第三种方式是添加新的字段去区别历史和新增


### 做过最难的指标
流量主题下的页面给予下游的贡献量
用sql把头皮抠出来都想不出 
然后去网上借鉴,去问问大佬,就知道可以用算法来实现
大致的步骤就是构建一个二叉树去便利每个页面的子页面,也就是用到了树的后序层次遍历
封装好方法写成dataframe 注册成UDF写spark-sql实现



